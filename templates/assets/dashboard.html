{% extends 'base.html' %}

{% block title %}Dashboard - Murang'a University Asset Management{% endblock %}

{% block page_title %}Dashboard Overview{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 4px solid #3498db;
    }

    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .stats-card.success {
        border-left-color: #27ae60;
    }

    .stats-card.warning {
        border-left-color: #f39c12;
    }

    .stats-card.danger {
        border-left-color: #e74c3c;
    }

    .stats-card.info {
        border-left-color: #3498db;
    }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
        margin-bottom: 15px;
    }

    .stats-icon.bg-success {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
    }

    .stats-icon.bg-warning {
        background: linear-gradient(135deg, #f39c12, #f1c40f);
    }

    .stats-icon.bg-danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }

    .stats-icon.bg-info {
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .stats-icon.bg-primary {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 10px 0;
    }

    .stats-label {
        color: #7f8c8d;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .stats-change {
        font-size: 0.85rem;
        margin-top: 8px;
    }

    .stats-change.positive {
        color: #27ae60;
    }

    .stats-change.negative {
        color: #e74c3c;
    }

    .chart-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

    .chart-card h5 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 1.1rem;
    }

    .table-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-card h5 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 1.1rem;
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        color: #2c3e50;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table tbody tr {
        transition: background 0.2s;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .badge {
        padding: 5px 12px;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .progress-thin {
        height: 6px;
        border-radius: 3px;
    }

    .section-header {
        margin: 30px 0 20px 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .stats-value {
            font-size: 1.5rem;
        }

        .chart-card, .table-card {
            padding: 15px;
        }

        .section-header {
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Cards Row -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="stats-card info">
            <div class="stats-icon bg-info">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stats-value">{{ total_assets }}</div>
            <div class="stats-label">Total Assets</div>
            <div class="stats-change positive">
                <i class="bi bi-arrow-up"></i> Active Inventory
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stats-card success">
            <div class="stats-icon bg-success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stats-value">{{ assets_in_use }}</div>
            <div class="stats-label">Assets In Use</div>
            <div class="stats-change positive">
                <i class="bi bi-graph-up"></i> {{ in_use_percentage }}% of total
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stats-card warning">
            <div class="stats-icon bg-warning">
                <i class="bi bi-tools"></i>
            </div>
            <div class="stats-value">{{ assets_under_maintenance }}</div>
            <div class="stats-label">Under Maintenance</div>
            <div class="stats-change">
                <i class="bi bi-exclamation-triangle"></i> Needs attention
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-3">
        <div class="stats-card success">
            <div class="stats-icon bg-primary">
                <i class="bi bi-bag-check"></i>
            </div>
            <div class="stats-value">{{ assets_available }}</div>
            <div class="stats-label">Available Assets</div>
            <div class="stats-change positive">
                <i class="bi bi-check2"></i> Ready for use
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-diagram-3 text-primary" style="font-size: 2rem; margin-right: 15px;"></i>
                <div>
                    <div class="stats-value" style="font-size: 1.5rem;">{{ department_count }}</div>
                    <div class="stats-label">Departments</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-tags text-success" style="font-size: 2rem; margin-right: 15px;"></i>
                <div>
                    <div class="stats-value" style="font-size: 1.5rem;">{{ category_count }}</div>
                    <div class="stats-label">Categories</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-arrow-left-right text-info" style="font-size: 2rem; margin-right: 15px;"></i>
                <div>
                    <div class="stats-value" style="font-size: 1.5rem;">{{ recent_movements }}</div>
                    <div class="stats-label">Recent Movements</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 col-6">
        <div class="stats-card">
            <div class="d-flex align-items-center">
                <i class="bi bi-wrench text-warning" style="font-size: 2rem; margin-right: 15px;"></i>
                <div>
                    <div class="stats-value" style="font-size: 1.5rem;">{{ recent_maintenance }}</div>
                    <div class="stats-label">Recent Maintenance</div>
                </div>
            </div>
        </div>
    </div>
</div>

<h4 class="section-header">
    <i class="bi bi-bar-chart-line"></i> Analytics Overview
</h4>

<!-- Charts Row 1 -->
<div class="row g-4 mb-4">
    <!-- Asset Status Distribution -->
    <div class="col-lg-4 col-md-6">
        <div class="chart-card">
            <h5><i class="bi bi-pie-chart"></i> Asset Status Distribution</h5>
            <canvas id="statusChart" style="max-height: 250px;"></canvas>
        </div>
    </div>

    <!-- Asset Condition -->
    <div class="col-lg-4 col-md-6">
        <div class="chart-card">
            <h5><i class="bi bi-speedometer2"></i> Asset Condition</h5>
            <canvas id="conditionChart" style="max-height: 250px;"></canvas>
        </div>
    </div>

    <!-- Monthly Trend -->
    <div class="col-lg-4 col-md-12">
        <div class="chart-card">
            <h5><i class="bi bi-graph-up"></i> Asset Addition Trend</h5>
            <canvas id="trendChart" style="max-height: 250px;"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row g-4 mb-4">
    <!-- Assets by Department -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h5><i class="bi bi-building"></i> Assets by Department</h5>
            <canvas id="departmentChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Assets by Category -->
    <div class="col-lg-6">
        <div class="chart-card">
            <h5><i class="bi bi-tags"></i> Assets by Category</h5>
            <canvas id="categoryChart" style="max-height: 300px;"></canvas>
        </div>
    </div>
</div>

<h4 class="section-header">
    <i class="bi bi-table"></i> Detailed Information
</h4>

<!-- Tables Row -->
<div class="row g-4">
    <!-- Recent Assets -->
    <div class="col-lg-6">
        <div class="table-card">
            <h5><i class="bi bi-clock-history"></i> Recently Added Assets</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Asset Name</th>
                            <th>Department</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in recent_assets %}
                        <tr>
                            <td>
                                <strong>{{ asset.name }}</strong><br>
                                <small class="text-muted">{{ asset.serial_number }}</small>
                            </td>
                            <td>{{ asset.department.name|default:"Unassigned" }}</td>
                            <td>
                                {% if asset.status == "Available" %}
                                <span class="badge bg-success">{{ asset.status }}</span>
                                {% elif asset.status == "In Use" %}
                                <span class="badge bg-primary">{{ asset.status }}</span>
                                {% elif asset.status == "Under Maintenance" %}
                                <span class="badge bg-warning text-dark">{{ asset.status }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ asset.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i><br>
                                No recent assets found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Assets Needing Attention -->
    <div class="col-lg-6">
        <div class="table-card">
            <h5><i class="bi bi-exclamation-triangle"></i> Assets Needing Attention</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Asset Name</th>
                            <th>Department</th>
                            <th>Issue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in assets_needing_attention %}
                        <tr>
                            <td>
                                <strong>{{ asset.name }}</strong><br>
                                <small class="text-muted">{{ asset.serial_number }}</small>
                            </td>
                            <td>{{ asset.department.name|default:"Unassigned" }}</td>
                            <td>
                                {% if asset.status == "Under Maintenance" %}
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-tools"></i> Maintenance
                                </span>
                                {% elif asset.condition == "Poor" %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-exclamation-circle"></i> Poor Condition
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-success py-4">
                                <i class="bi bi-check-circle" style="font-size: 2rem;"></i><br>
                                All assets are in good condition!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Top Departments Table -->
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="table-card">
            <h5><i class="bi bi-trophy"></i> Top Departments by Asset Count</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Department</th>
                            <th>Location</th>
                            <th>Head of Department</th>
                            <th>Asset Count</th>
                            <th>Distribution</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept in top_departments %}
                        <tr>
                            <td>
                                <strong style="font-size: 1.1rem; color: #3498db;">#{{ forloop.counter }}</strong>
                            </td>
                            <td><strong>{{ dept.name }}</strong></td>
                            <td>
                                <i class="bi bi-geo-alt text-muted"></i> 
                                {{ dept.location|default:"N/A" }}
                            </td>
                            <td>
                                <i class="bi bi-person text-muted"></i> 
                                {{ dept.head_of_department|default:"N/A" }}
                            </td>
                            <td>
                                <span class="badge bg-primary" style="font-size: 0.9rem;">
                                    {{ dept.asset_count }} asset{{ dept.asset_count|pluralize }}
                                </span>
                            </td>
                            <td style="width: 200px;">
                                <div class="progress progress-thin">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {% widthratio dept.asset_count top_departments.0.asset_count 100 %}%"
                                         aria-valuenow="{{ dept.asset_count }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="{{ top_departments.0.asset_count }}">
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i><br>
                                No departments found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart.js Global Configuration
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#7f8c8d';

    // Status Distribution Pie Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                data: {{ status_data|safe }},
                backgroundColor: [
                    '#27ae60',
                    '#3498db',
                    '#f39c12',
                    '#e74c3c',
                    '#95a5a6'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Condition Doughnut Chart
    const conditionCtx = document.getElementById('conditionChart').getContext('2d');
    new Chart(conditionCtx, {
        type: 'doughnut',
        data: {
            labels: {{ condition_labels|safe }},
            datasets: [{
                data: {{ condition_data|safe }},
                backgroundColor: [
                    '#27ae60',
                    '#3498db',
                    '#f39c12',
                    '#e74c3c'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Monthly Trend Line Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ month_labels|safe }},
            datasets: [{
                label: 'Assets Added',
                data: {{ monthly_additions|safe }},
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return `Assets Added: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });

    // Department Bar Chart
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    new Chart(departmentCtx, {
        type: 'bar',
        data: {
            labels: {{ department_labels|safe }},
            datasets: [{
                label: 'Number of Assets',
                data: {{ department_data|safe }},
                backgroundColor: '#3498db',
                borderColor: '#2980b9',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Assets: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });

    // Category Horizontal Bar Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                label: 'Number of Assets',
                data: {{ category_data|safe }},
                backgroundColor: [
                    '#3498db',
                    '#27ae60',
                    '#f39c12',
                    '#e74c3c',
                    '#9b59b6',
                    '#1abc9c'
                ],
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Assets: ${context.parsed.x}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });
</script>
{% endblock %}